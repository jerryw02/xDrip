name: Build APK

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: [ 11, 17 ]  # æ”¯æŒä¸¤ç§Javaç‰ˆæœ¬

    steps:
    - uses: actions/checkout@v2
    
    - uses: actions/setup-java@v2
      with:
        java-version: ${{ matrix.java-version }}
        distribution: adopt
    
    # æ ¹æ®ä½ çš„é¡¹ç›®ï¼Œå¯èƒ½å·²ç»æœ‰è¿™ä¸ªé…ç½®äº†ï¼Œå…ˆæ£€æŸ¥
    - name: Check Gradle configuration
      run: |
        echo "=== Current gradle-wrapper.properties ==="
        cat gradle/wrapper/gradle-wrapper.properties || echo "File not found"
        echo ""
        echo "=== Checking for gradle.properties ==="
        cat gradle.properties 2>/dev/null || echo "No gradle.properties found"
    
    # å¦‚æœGradleç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œè‡ªåŠ¨ä¿®å¤
    - name: Fix Gradle version if needed
      run: |
        # æ£€æŸ¥å½“å‰Gradleç‰ˆæœ¬
        CURRENT_VERSION=$(grep -o 'gradle-[0-9.]*' gradle/wrapper/gradle-wrapper.properties | head -1 | sed 's/gradle-//')
        echo "Current Gradle version: $CURRENT_VERSION"
        
        # å¦‚æœç‰ˆæœ¬ä½äº7.5ï¼Œæ›´æ–°åˆ°8.0
        if [[ "$CURRENT_VERSION" < "7.5" ]]; then
          echo "Updating Gradle to 8.0 (minimum required is 7.5)"
          sed -i 's|distributionUrl=.*|distributionUrl=https\://services.gradle.org/distributions/gradle-8.0-all.zip|g' gradle/wrapper/gradle-wrapper.properties
        fi
        
        echo "=== Updated gradle-wrapper.properties ==="
        cat gradle/wrapper/gradle-wrapper.properties
    
    # ç¡®ä¿æœ‰æ­£ç¡®çš„gradle.properties
    - name: Setup Gradle properties
      run: |
        # åˆ›å»ºæˆ–æ›´æ–°gradle.properties
        cat > gradle.properties << 'EOF'
# Java VM settings
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
org.gradle.daemon=false

# Android settings
android.useAndroidX=true
android.enableJetifier=true

# Build performance
org.gradle.parallel=true
org.gradle.caching=true
org.gradle.configureondemand=true

# CI specific
android.enablePreDex=false
EOF
        
        # ç¡®ä¿æœ¬åœ°å±æ€§å­˜åœ¨
        if [ ! -f local.properties ]; then
          echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
        fi
    
    # è®¾ç½®Android SDKï¼ˆå¦‚æœéœ€è¦ï¼‰
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        accept-android-licenses: true
    
    # ä¸»æ„å»ºæ­¥éª¤ - æ„å»ºæ‰€æœ‰ç±»å‹çš„APK
    - name: Build all APKs
      uses: gradle/gradle-build-action@v2
      with:
        arguments: |
          clean 
          assembleDebug 
          assembleRelease 
          assembleProdRelease 
          --stacktrace 
          --no-daemon
        cache-read-only: false
    
    # å¯é€‰ï¼šå¦‚æœé¡¹ç›®æœ‰ç‰¹å®šçš„å˜ä½“ï¼Œå¯ä»¥æ„å»ºæ›´å¤š
    - name: Build specific variants (optional)
      if: false  # é»˜è®¤ç¦ç”¨ï¼Œéœ€è¦æ—¶å¯ç”¨
      uses: gradle/gradle-build-action@v2
      with:
        arguments: |
          assembleFullDebug
          assembleFullRelease
          assembleProdDebug
          assembleProdRelease
          --stacktrace
          --no-daemon
    
    # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„APKæ–‡ä»¶
    - name: List generated APKs
      run: |
        echo "=== All APK files ==="
        find . -name "*.apk" -type f 2>/dev/null | while read apk; do
          SIZE=$(du -h "$apk" | cut -f1)
          echo "ğŸ“± $apk ($SIZE)"
          ls -la "$apk"
        done || echo "No APK files found"
        
        echo ""
        echo "=== APK directory structure ==="
        find app/build/outputs/apk -type f 2>/dev/null || echo "No APK outputs found"
    
    # æ”¶é›†å¹¶ä¸Šä¼ APKæ–‡ä»¶
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v2
      with:
        name: apk-files-java-${{ matrix.java-version }}
        path: |
          app/build/outputs/apk/
          **/*.apk
        retention-days: 30
    
    # æ”¶é›†æ„å»ºæŠ¥å‘Š
    - name: Upload build reports
      uses: actions/upload-artifact@v2
      with:
        name: build-reports-java-${{ matrix.java-version }}
        path: |
          app/build/reports/
          build/reports/
        retention-days: 30
    
    # è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
    - name: Run unit tests
      uses: gradle/gradle-build-action@v2
      with:
        arguments: testProdReleaseUnitTest --stacktrace --no-daemon
    
    # è¿è¡Œæ£€æŸ¥è„šæœ¬ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
    - name: Check Output
      run: bash ./etc/CheckBuild/check-release.sh test
