name: Build xDrip APK (Step by Step)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史，可能包含git描述需要
        
    - name: Fix git describe issue
      run: |
        # 修复 "fatal: No names found" 错误
        git fetch --tags || true
        git describe --tags --always --dirty=-dev 2>/dev/null || echo "v0.0.0-dev"
        
    - name: Set up Java 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Step 1 - Build libkeks module
      run: |
        echo "=== 第一步: 构建libkeks模块 ==="
        ./gradlew :libkeks:compileDebugJavaWithJavac :libkeks:generateDebugRFile \
          --no-daemon --stacktrace --info || true
        
    - name: Step 2 - Build localeapi module
      run: |
        echo "=== 第二步: 构建localeapi模块 ==="
        ./gradlew :localeapi:compileDebugJavaWithJavac \
          --no-daemon --stacktrace --info || true
        
    - name: Step 3 - Build app module
      run: |
        echo "=== 第三步: 构建主应用模块 ==="
        # 先尝试不包含数据绑定的构建
        ./gradlew :app:compileProdDebugJavaWithJavac \
          :app:generateProdDebugResources \
          :app:generateProdDebugRFile \
          --no-daemon --stacktrace --info
        
    - name: Step 4 - Full build
      run: |
        echo "=== 第四步: 完整构建 ==="
        ./gradlew assembleProdDebug --no-daemon --stacktrace --info
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: xDrip-StepByStep
        path: app/build/outputs/apk/prod/debug/*.apk
