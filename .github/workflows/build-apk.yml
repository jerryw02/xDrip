name: Build xDrip-APK

#on:
#  workflow_dispatch:
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [ 11 ]

    steps:
    # 1. 使用明确版本的 checkout
    - uses: actions/checkout@v4 # 使用最新的 v4
    
    - uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin' # 'adopt' 已过时，建议使用 'temurin'

    # 2. 手动执行 Gradle 命令，而不是使用 gradle-build-action
    # 这是为了避免那个 Action 内部可能隐式调用旧版 upload-artifact
    - name: Make Gradle Executable
      run: chmod +x gradlew

    - name: Build APK (Assemble)
      run: ./gradlew assembleProdDebug

    # 3. 关键：强制使用最新的 upload-artifact
    - name: Upload APK
      # 强制锁定版本
      uses: actions/upload-artifact@v4
      with:
        name: xDrip-Apk
        path: app/build/outputs/apk/prod/debug/*.apk
        # 如果文件路径不存在也不要报错，防止卡住
        if-no-files-found: warn 
